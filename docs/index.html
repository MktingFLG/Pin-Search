<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PIN Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    details > summary::marker { display: none; }
    details > summary::-webkit-details-marker { display: none; }
  </style>
</head>
<body class="bg-gray-50">

<main class="mx-auto p-4 md:p-6" style="max-width: 1000px;">
  <!-- FRONT PAGE -->
  <div id="frontPage" class="bg-white shadow rounded-2xl p-6 space-y-6">
    <div id="notice" class="bg-yellow-100 border border-yellow-300 text-yellow-800 px-4 py-2 rounded">
      ⚠️ Assessor update: Township XYZ updated on Sept 1, 2025
    </div>
    <div class="flex gap-2 items-center">
      <input id="frontPinInput" type="text" placeholder="Enter PIN (e.g. 33-29-200-014-0000)"
             class="border rounded-lg px-3 py-2 text-sm w-80"/>
      <button id="frontSearchBtn" class="px-3 py-2 rounded-lg border">Search</button>
    </div>
    <div class="border rounded-2xl">
      <div class="px-4 py-2 font-medium bg-gray-100 rounded-t-2xl">Latest Commercial Sales</div>
      <div class="px-4 py-3">
        <div id="frontMap" class="h-96 w-full rounded-xl border"></div>
        <div class="text-xs text-gray-500 mt-2">Recent commercial property sales across Cook County.</div>
      </div>
    </div>
  </div>

  <!-- RESULTS PAGE -->
  <div id="resultsPage" class="hidden bg-white shadow rounded-2xl p-6 space-y-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <h1 class="text-xl md:text-2xl font-semibold">PIN Overview</h1>
      <div class="flex gap-2 items-center">
        <input id="pinInput" type="text" class="border rounded-lg px-3 py-2 text-sm w-80"/>
        <button id="loadBtn" class="px-3 py-2 rounded-lg border">Reload</button>
        <button id="freshBtn" class="px-3 py-2 rounded-lg border">Reload (Fresh)</button>
        <button id="backBtn" class="px-3 py-2 rounded-lg border">Back</button>
      </div>
    </div>
    <div id="meta" class="text-xs text-gray-500 mb-2"></div>
    <div class="flex gap-2 items-center mb-2">
      <label for="radiusSelect" class="text-sm">Nearby radius:</label>
      <select id="radiusSelect" class="border rounded px-2 py-1 text-sm">
        <option value="5">5 miles</option>
        <option value="10">10 miles</option>
        <option value="15">15 miles</option>
      </select>
    </div>
    <div class="border rounded-2xl mb-4">
      <div class="px-4 py-2 font-medium bg-gray-100 rounded-t-2xl">Map</div>
      <div class="px-4 py-3">
        <div id="map" class="h-96 w-full rounded-xl border"></div>
      </div>
    </div>
    <div id="sections" class="space-y-3"></div>
  </div>
</main>

<script>
const $ = sel => document.querySelector(sel);
const el = (tag, props={}, ...kids) => {
  const node = document.createElement(tag);
  Object.assign(node, props);
  kids.flat().forEach(k => node.appendChild(k.nodeType ? k : document.createTextNode(String(k))));
  return node;
};

// --- Render helpers ---
function renderKeyValues(obj) {
  const dl = el("dl",{className:"grid grid-cols-2 gap-x-4 gap-y-1"});
  Object.entries(obj||{}).forEach(([k,v])=>{
    dl.appendChild(el("dt",{className:"font-semibold"},k));
    dl.appendChild(el("dd",{className:"text-gray-700"},v??""));
  });
  return dl;
}
function renderRowsAsTable(rows) {
  if (!rows || !rows.length) return el("div",{},"No data");
  const cols = Object.keys(rows[0]||{});
  const table = el("table",{className:"w-full text-sm border-collapse"});
  const thead = el("thead");
  thead.appendChild(el("tr",{},...cols.map(c=>el("th",{className:"text-left border-b px-2 py-1 font-semibold"},c))));
  table.appendChild(thead);
  const tbody = el("tbody");
  rows.forEach(r=>{
    tbody.appendChild(el("tr",{},...cols.map(c=>el("td",{className:"border-b px-2 py-1"},r[c]??""))));
  });
  table.appendChild(tbody);
  return table;
}
const SECTION_RENDERERS = {
  assessor_profile: renderKeyValues,
  assessor_values: renderKeyValues,
  sales: (c)=>{
    const wrap = el("div",{className:"space-y-2"});
    if (c?.["Latest Sale Date"] || c?.["Latest Sale Price"]) {
      wrap.appendChild(renderKeyValues({
        "Latest Sale Date": c["Latest Sale Date"],
        "Latest Sale Price": c["Latest Sale Price"],
      }));
    }
    if (Array.isArray(c?.History)) wrap.appendChild(renderRowsAsTable(c.History));
    return wrap;
  },
  nearby: (c)=>renderRowsAsTable(c?.features||[])
};
function renderGeneric(content) {
  if (Array.isArray(content)) return renderRowsAsTable(content);
  if (content && typeof content==="object") return renderKeyValues(content);
  return el("div",{},content??"");
}
function renderSection(key,title,content) {
  const details = el("details",{className:"border rounded-xl"});
  details.appendChild(el("summary",{className:"cursor-pointer px-4 py-2 font-medium bg-gray-100 rounded-t-xl"},title));
  const body = el("div",{className:"px-4 py-3 text-sm"});
  const renderer = SECTION_RENDERERS[key]||renderGeneric;
  body.appendChild(renderer(content));
  details.appendChild(body);
  return details;
}

// --- Maps ---
let _map,_frontMap;
function initMaps() {
  if (!_frontMap) {
    _frontMap = L.map("frontMap").setView([41.88,-87.63],11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(_frontMap);
  }
  if (!_map) {
    _map = L.map("map").setView([41.88,-87.63],11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(_map);
  }
}

// --- Core loading ---
async function loadPin(pin,fresh=false) {
  $("#meta").textContent="Loading…"; $("#sections").innerHTML=""; $("#pinInput").value=pin;
  setTimeout(()=>_map.invalidateSize(),200); // fix Leaflet sizing

  // Core sections
  const profile = await (await fetch(`/assessor/profile?pin=${pin}`)).json();
  $("#sections").appendChild(renderSection("assessor_profile","Assessor Profile",profile));
  const values = await (await fetch(`/assessor/values?pin=${pin}`)).json();
  $("#sections").appendChild(renderSection("assessor_values","Assessment Values",values));
  const sales = await (await fetch(`/sales?pin=${pin}`)).json();
  $("#sections").appendChild(renderSection("sales","Sales",sales));

  // Nearby
  const radius=$("#radiusSelect").value;
  fetch(`/api/nearby-mini/${pin}?radius=${radius}`).then(r=>r.json()).then(d=>{
    $("#sections").appendChild(renderSection("nearby","Nearby Properties",d));
    if (d?.subject?.lat && d?.subject?.lon) {
      _map.setView([d.subject.lat,d.subject.lon],13);
      L.marker([d.subject.lat,d.subject.lon]).addTo(_map).bindPopup(`Subject: ${pin}`).openPopup();
    }
  });

  // Lazy sections
  addLazySection("Permits (CCAO)",`/ccao/permits?pin=${pin}`,"permits_ccao");
  addLazySection("Delinquent Taxes",`/delinquent?pin=${pin}`,"delinquent");
  addLazySection("PTAB",`/ptab/by-pin?pin=${pin}`,"ptab");

  $("#meta").textContent=`PIN ${pin} • Core sections loaded`;
}
function addLazySection(title,url,key) {
  const details=el("details",{className:"border rounded-xl"});
  details.appendChild(el("summary",{className:"cursor-pointer px-4 py-2 font-medium bg-gray-100 rounded-t-xl"},title));
  const body=el("div",{className:"px-4 py-3 text-sm"},"Click to load…");
  details.appendChild(body);
  details.addEventListener("toggle",async()=>{
    if(details.open && body.textContent==="Click to load…"){
      const d=await (await fetch(url)).json();
      body.innerHTML=""; const renderer=SECTION_RENDERERS[key]||renderGeneric;
      body.appendChild(renderer(d));
    }
  });
  $("#sections").appendChild(details);
}

// --- Events ---
$("#frontSearchBtn").addEventListener("click",()=>{
  const pin=$("#frontPinInput").value.trim(); if(!pin) return;
  $("#frontPage").classList.add("hidden"); $("#resultsPage").classList.remove("hidden");
  loadPin(pin);
});
$("#backBtn").addEventListener("click",()=>{
  $("#resultsPage").classList.add("hidden"); $("#frontPage").classList.remove("hidden");
});
$("#loadBtn").addEventListener("click",()=>loadPin($("#pinInput").value.trim(),false));
$("#freshBtn").addEventListener("click",()=>loadPin($("#pinInput").value.trim(),true));
$("#radiusSelect").addEventListener("change",()=>loadPin($("#pinInput").value.trim(),false));

initMaps();
</script>
</body>
</html>

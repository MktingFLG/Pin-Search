<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PIN Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    details > summary::marker { display: none; }
    details > summary::-webkit-details-marker { display: none; }
  </style>
</head>
<body class="bg-gray-50">

<main class="mx-auto p-4 md:p-6" style="max-width: 1200px;">
  <!-- FRONT PAGE -->
  <div id="frontPage" class="bg-white shadow rounded-2xl p-6 space-y-6">
    <div id="notice" class="bg-yellow-100 border border-yellow-300 text-yellow-800 px-4 py-2 rounded">
      ⚠️ Assessor update: Township XYZ updated on Sept 1, 2025
    </div>
    <div class="flex gap-2 items-center">
      <input id="frontPinInput" type="text" placeholder="Enter PIN (e.g. 33-29-200-014-0000)"
             class="border rounded-lg px-3 py-2 text-sm w-80"/>
      <button id="frontSearchBtn" class="px-3 py-2 rounded-lg border">Search</button>
    </div>
    <div class="border rounded-2xl">
      <div class="px-4 py-2 font-medium bg-gray-100 rounded-t-2xl">Latest Commercial Sales</div>
      <div class="px-4 py-3">
        <div id="frontMap" class="h-96 w-full rounded-xl border"></div>
        <div class="text-xs text-gray-500 mt-2">Recent commercial property sales across Cook County.</div>
      </div>
    </div>
  </div>

  <!-- RESULTS PAGE -->
  <div id="resultsPage" class="hidden bg-white shadow rounded-2xl p-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
      <h1 class="text-xl md:text-2xl font-semibold">PIN Overview</h1>
      <div class="flex gap-2 items-center">
        <input id="pinInput" type="text" class="border rounded-lg px-3 py-2 text-sm w-80"/>
        <button id="loadBtn" class="px-3 py-2 rounded-lg border">Reload</button>
        <button id="freshBtn" class="px-3 py-2 rounded-lg border">Reload (Fresh)</button>
        <button id="backBtn" class="px-3 py-2 rounded-lg border">Back</button>
      </div>
    </div>
    <div id="meta" class="text-xs text-gray-500 mb-4"></div>

    <div class="flex gap-6">
      <!-- Sidebar TOC -->
      <aside id="toc" class="w-48 shrink-0 hidden md:block">
        <div class="sticky top-6 space-y-2 text-sm">
          <h2 class="font-semibold mb-2">Sections</h2>
          <ul id="tocList" class="space-y-1 text-gray-700"></ul>
        </div>
      </aside>

      <!-- Main sections -->
      <div id="sections" class="flex-1 space-y-3"></div>
    </div>
  </div>
</main>

<script>
const $ = sel => document.querySelector(sel);
const el = (tag, props={}, ...kids) => {
  const node=document.createElement(tag); Object.assign(node,props);
  kids.flat().forEach(k=>node.appendChild(k.nodeType?k:document.createTextNode(String(k))));
  return node;
};

// --- Helpers to render ---
function renderKeyValues(obj) {
  if (!obj || !Object.keys(obj).length) return el("div",{},"No data");
  const dl=el("dl",{className:"grid grid-cols-2 gap-x-4 gap-y-1"});
  Object.entries(obj).forEach(([k,v])=>{
    dl.appendChild(el("dt",{className:"font-semibold"},k));
    dl.appendChild(el("dd",{className:"text-gray-700"},v??""));
  });
  return dl;
}
function renderRowsAsTable(rows) {
  if (!rows || !rows.length) return el("div",{},"No rows");
  const cols=Object.keys(rows[0]||{});
  const table=el("table",{className:"w-full text-sm border-collapse"});
  const thead=el("thead");
  thead.appendChild(el("tr",{},...cols.map(c=>el("th",{className:"text-left border-b px-2 py-1 font-semibold"},c))));
  table.appendChild(thead);
  const tbody=el("tbody");
  rows.forEach(r=>tbody.appendChild(el("tr",{},...cols.map(c=>el("td",{className:"border-b px-2 py-1"},r[c]??"")))));
  table.appendChild(tbody);
  return table;
}

// --- Summary extractors ---
const SECTION_SUMMARIES = {
  assessor_profile: c => `${c?.["PIN Info • Property Address"] || ""}, Class ${c?.["PIN Info • Class"] || ""}`,
  value_summary: c => c?.[0] ? `AV: ${c[0].Total}` : "No AV data",
  sales: c => `Latest: ${c?.["Latest Sale Date"] || ""} • ${c?.["Latest Sale Price"] || ""}`,
  delinquent: c => c?.data?.length ? `Billed: $${c.data[0].TotalBilled}, Due: $${c.data[0].TotalDue}` : "No delinquency",
  tax_bill: c => c?.total_billed ? `Tax Billed: $${c.total_billed}` : "No tax bill",
};

// --- Section renderers ---
const SECTION_RENDERERS = {
  assessor_profile: renderKeyValues,
  value_summary: renderRowsAsTable,
  ptax: (c)=>renderRowsAsTable(c?.rows||[]),
  sales: (c)=>{
    const wrap = el("div",{className:"space-y-2"});
    if(!c) return el("div",{},"No sales data");
    const latestDate = c["Latest Sale Date"] || "";
    const latestPrice = c["Latest Sale Price"] || "";
    if(latestDate || latestPrice) {
      wrap.appendChild(el("div",{className:"font-semibold text-gray-800"},
        `Latest Sale: ${latestDate} • ${latestPrice}`));
    }
    if(Array.isArray(c.History) && c.History.length) {
      const details = el("details",{className:"border rounded"});
      details.appendChild(
        el("summary",{className:"cursor-pointer px-2 py-1 bg-gray-50 font-medium"},
          `Full Sales History (${c.History.length})`));
      const body = el("div",{className:"px-2 py-1 text-sm"});
      body.appendChild(renderRowsAsTable(c.History));
      details.appendChild(body);
      wrap.appendChild(details);
    }
    return wrap;
  },
  permits: (c)=>renderRowsAsTable(c?.rows||[]),
  delinquent: (c)=>renderRowsAsTable(c?.data||[]),
  ptab: (c)=>renderRowsAsTable(c||[]),
  nearby: (c)=>renderRowsAsTable(c?.features||[])
};

// --- TOC + Section builder ---
function addToTOC(key, title) {
  const li = el("li",{}, el("a",{href:"#section-"+key,className:"hover:underline"},title));
  $("#tocList").appendChild(li);
}
function renderSection(key,title,content) {
  const details=el("details",{id:"section-"+key,className:"border rounded-xl"});
  const summaryText = (SECTION_SUMMARIES[key] ? SECTION_SUMMARIES[key](content) : "");
  const summaryEl = el("summary",{className:"cursor-pointer px-4 py-2 bg-gray-100 font-medium flex justify-between items-center"},
    title,
    el("span",{className:"text-xs text-gray-500"}, summaryText)
  );
  details.appendChild(summaryEl);
  const body=el("div",{className:"px-4 py-3 text-sm"});
  const renderer=SECTION_RENDERERS[key]||renderKeyValues;
  // lazy render
  details.addEventListener("toggle",()=>{
    if(details.open && !body.hasChildNodes()) body.appendChild(renderer(content));
  });
  details.appendChild(body);
  addToTOC(key,title);
  return details;
}

// --- Load PIN ---
async function loadPin(pin,fresh=false) {
  $("#meta").textContent="Loading…"; 
  $("#sections").innerHTML=""; 
  $("#tocList").innerHTML="";
  $("#pinInput").value=pin;
  const url = `/api/pin/${encodeURIComponent(pin)}${fresh?"?fresh=1":""}`;
  const resp = await fetch(url);
  if (!resp.ok) {
    $("#meta").textContent = `API error: ${resp.status}`;
    return;
  }
  const data = await resp.json();
  $("#meta").textContent=`PIN ${data.pin} • Generated ${new Date(data.generated_at).toLocaleString()}`;
  const sec=data.sections||{};
  Object.entries(sec).forEach(([k,v])=>{
    $("#sections").appendChild(renderSection(k,k.replace(/_/g," "),v));
  });
}

// --- Events ---
$("#frontSearchBtn").addEventListener("click",()=>{
  const pin=$("#frontPinInput").value.trim(); if(!pin) return;
  $("#frontPage").classList.add("hidden"); $("#resultsPage").classList.remove("hidden");
  loadPin(pin);
});
$("#backBtn").addEventListener("click",()=>{
  $("#resultsPage").classList.add("hidden"); $("#frontPage").classList.remove("hidden");
});
$("#loadBtn").addEventListener("click",()=>loadPin($("#pinInput").value.trim(),false));
$("#freshBtn").addEventListener("click",()=>loadPin($("#pinInput").value.trim(),true));

// --- Maps init ---
let _frontMap;
function initMaps() {
  if(!_frontMap) {
    _frontMap=L.map("frontMap").setView([41.88,-87.63],11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(_frontMap);
  }
}
initMaps();
</script>
</body>
</html>

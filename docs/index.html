<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PIN Tool</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    details > summary::marker { display: none; }
    details > summary::-webkit-details-marker { display: none; }
  </style>
</head>
<body class="bg-gray-50">

<main class="mx-auto p-4 md:p-6" style="max-width: 1000px;">
  <!-- FRONT PAGE -->
  <div id="frontPage" class="bg-white shadow rounded-2xl p-6 space-y-6">
    <div id="notice" class="bg-yellow-100 border border-yellow-300 text-yellow-800 px-4 py-2 rounded">
      ⚠️ Assessor update: Township XYZ updated on Sept 1, 2025
    </div>

    <div class="flex gap-2 items-center">
      <input id="frontPinInput" type="text" placeholder="Enter PIN (e.g. 33-29-200-014-0000)"
             class="border rounded-lg px-3 py-2 text-sm w-80"/>
      <button id="frontSearchBtn" class="px-3 py-2 rounded-lg border">Search</button>
    </div>

    <div class="border rounded-2xl">
      <div class="px-4 py-2 font-medium bg-gray-100 rounded-t-2xl">Latest Commercial Sales</div>
      <div class="px-4 py-3">
        <div id="frontMap" class="h-96 w-full rounded-xl border"></div>
        <div class="text-xs text-gray-500 mt-2">Recent commercial property sales across Cook County.</div>
      </div>
    </div>
  </div>

  <!-- RESULTS PAGE -->
  <div id="resultsPage" class="hidden bg-white shadow rounded-2xl p-6 space-y-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <h1 class="text-xl md:text-2xl font-semibold">PIN Overview</h1>
      <div class="flex gap-2 items-center">
        <input id="pinInput" type="text" class="border rounded-lg px-3 py-2 text-sm w-80"/>
        <button id="loadBtn" class="px-3 py-2 rounded-lg border">Reload</button>
        <button id="freshBtn" class="px-3 py-2 rounded-lg border">Reload (Fresh)</button>
        <button id="backBtn" class="px-3 py-2 rounded-lg border">Back</button>
      </div>
    </div>

    <div id="meta" class="text-xs text-gray-500 mb-2"></div>

    <!-- Radius selector -->
    <div class="flex gap-2 items-center mb-2">
      <label for="radiusSelect" class="text-sm">Nearby radius:</label>
      <select id="radiusSelect" class="border rounded px-2 py-1 text-sm">
        <option value="5">5 miles</option>
        <option value="10">10 miles</option>
        <option value="15">15 miles</option>
      </select>
    </div>

    <!-- Map -->
    <div class="border rounded-2xl mb-4">
      <div class="px-4 py-2 font-medium bg-gray-100 rounded-t-2xl">Map</div>
      <div class="px-4 py-3">
        <div id="map" class="h-96 w-full rounded-xl border"></div>
      </div>
    </div>

    <!-- Sections -->
    <div id="sections" class="space-y-3"></div>
  </div>
</main>

<script>
const API_BASE = "";
const $ = sel => document.querySelector(sel);
const el = (tag, props={}, ...kids) => {
  const node = document.createElement(tag);
  Object.assign(node, props);
  kids.flat().forEach(k => node.appendChild(k.nodeType ? k : document.createTextNode(String(k))));
  return node;
};

// Map helpers
let _map, _frontMap;
function ensureMap(id) {
  return L.map(id).setView([41.88,-87.63], 11); // Chicago default
}
function initMaps() {
  if (!_frontMap) {
    _frontMap = ensureMap("frontMap");
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(_frontMap);
  }
  if (!_map) {
    _map = ensureMap("map");
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(_map);
  }
}

// Incremental data loading for results page
async function loadPin(pin, fresh=false) {
  $("#meta").textContent = "Loading…";
  $("#sections").innerHTML = "";
  $("#pinInput").value = pin;

  // 1. Load profile (light)
  try {
    const profile = await (await fetch(`/assessor/profile?pin=${pin}`)).json();
    $("#sections").appendChild(renderSection("assessor_profile", "Assessor Profile", profile));
  } catch {}

  // 2. Load maildetail
  fetch(`/assessor/maildetail?pin=${pin}`).then(r=>r.json()).then(d=>{
    $("#sections").appendChild(renderSection("assessor_maildetail","Assessor Mailing Detail",d));
  });

  // 3. Load nearby (with chosen radius)
  const radius = $("#radiusSelect").value;
  fetch(`/api/nearby-mini/${pin}?radius=${radius}`).then(r=>r.json()).then(d=>{
    renderNearby(d);
    $("#sections").appendChild(renderSection("nearby","Nearby Properties",d));
  });

  // 4. Load heavier ones later
  fetch(`/delinquent?pin=${pin}`).then(r=>r.json()).then(d=>{
    $("#sections").appendChild(renderSection("delinquent","Delinquent Taxes",d));
  });
  fetch(`/ccao/permits?pin=${pin}`).then(r=>r.json()).then(d=>{
    $("#sections").appendChild(renderSection("permits_ccao","Permits (CCAO)",d));
  });
  fetch(`/ptab/by-pin?pin=${pin}`).then(r=>r.json()).then(d=>{
    $("#sections").appendChild(renderSection("ptab","PTAB",d));
  });

  $("#meta").textContent = `PIN ${pin} • Loaded`;
}

// Render helpers
function renderSection(key, title, content) {
  const details = el("details", {className:"border rounded-xl"});
  details.appendChild(el("summary",{className:"cursor-pointer px-4 py-2 font-medium bg-gray-100 rounded-t-xl"}, title));
  details.appendChild(el("div",{className:"px-4 py-3 text-sm"}, JSON.stringify(content)));
  return details;
}
function renderNearby(data) {
  _map.setView([data.subject.lat, data.subject.lon], 13);
  L.marker([data.subject.lat, data.subject.lon]).addTo(_map)
    .bindPopup(`Subject: ${data.pin}`).openPopup();
  (data.nearby || []).forEach(f=>{
    const popup = `${f.pin}<br>${f.class||""} ${f.property_use||""}<br>Sale: ${f.latest_sale_price||""}`;
    L.marker([f.lat,f.lon]).addTo(_map).bindPopup(popup);
  });
}

// Events
$("#frontSearchBtn").addEventListener("click", ()=>{
  const pin = $("#frontPinInput").value.trim();
  if (!pin) return;
  $("#frontPage").classList.add("hidden");
  $("#resultsPage").classList.remove("hidden");
  loadPin(pin);
});
$("#backBtn").addEventListener("click", ()=>{
  $("#resultsPage").classList.add("hidden");
  $("#frontPage").classList.remove("hidden");
});
$("#loadBtn").addEventListener("click", ()=>loadPin($("#pinInput").value.trim(),false));
$("#freshBtn").addEventListener("click", ()=>loadPin($("#pinInput").value.trim(),true));
$("#radiusSelect").addEventListener("change", ()=>loadPin($("#pinInput").value.trim(),false));

initMaps();
</script>
</body>
</html>
